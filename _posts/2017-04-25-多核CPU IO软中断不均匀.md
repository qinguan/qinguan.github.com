---
layout: post
title: 多核CPU IO软中断不均匀
---

近期查openstack虚拟机丢包问题时发现多核的nginx服务器中某个core软中断占比较高。

	top - 22:32:29 up 509 days, 11:54,  2 users,  load average: 0.50, 0.56, 0.53
	Tasks: 221 total,   3 running, 218 sleeping,   0 stopped,   0 zombie
	Cpu0  : 16.8%us, 16.4%sy,  0.0%ni, 64.8%id,  0.3%wa,  0.0%hi,  0.0%si,  1.7%st
	Cpu1  : 16.2%us, 15.8%sy,  0.0%ni, 67.3%id,  0.0%wa,  0.0%hi,  0.0%si,  0.7%st
	Cpu2  : 17.4%us, 16.4%sy,  0.0%ni, 65.6%id,  0.0%wa,  0.0%hi,  0.0%si,  0.7%st
	Cpu3  : 15.7%us, 15.4%sy,  0.0%ni, 68.6%id,  0.0%wa,  0.0%hi,  0.0%si,  0.3%st
	Cpu4  :  9.0%us,  8.0%sy,  0.0%ni, 20.1%id,  0.0%wa,  0.0%hi, 62.2%si,  0.7%st
	Cpu5  : 15.4%us, 14.7%sy,  0.0%ni, 69.6%id,  0.0%wa,  0.0%hi,  0.0%si,  0.3%st
	Cpu6  : 15.9%us, 13.8%sy,  0.0%ni, 69.7%id,  0.0%wa,  0.0%hi,  0.0%si,  0.7%st
	Cpu7  : 17.2%us, 17.9%sy,  0.0%ni, 63.9%id,  0.0%wa,  0.0%hi,  0.3%si,  0.7%st
	Mem:   7828428k total,  7154060k used,   674368k free,     7808k buffers
	Swap:  4194300k total,   175548k used,  4018752k free,  5639768k cached

如上，Cpu4的si值达到了62.2，远高于其他core。

	# cat /proc/interrupts
	           CPU0       CPU1       CPU2       CPU3       CPU4       CPU5       CPU6       CPU7       
	  0:        134          0          0          0          0          0          0          0   IO-APIC-edge      timer
	  1:          6          0          0          0          0          0          0          0   IO-APIC-edge      i8042
	  3:          1          0          0          0          0          0          0          0   IO-APIC-edge    
	  4:        126          0          0          0          0          0          0          0   IO-APIC-edge      serial
	  8:          0          0          0          0          0          0          0          0   IO-APIC-edge      rtc0
	  9:          0          0          0          0          0          0          0          0   IO-APIC-fasteoi   acpi
	 11:      16442          0          0          0          0          0          0          0   IO-APIC-fasteoi   uhci_hcd:usb1, virtio5
	 12:        104          0          0          0          0          0          0          0   IO-APIC-edge      i8042
	 14:          0          0          0          0          0          0          0          0   IO-APIC-edge      ata_piix
	 15:          0          0          0          0          0          0          0          0   IO-APIC-edge      ata_piix
	 24:          0          0          0          0          0          0          0          0   PCI-MSI-edge      virtio3-config
	 25:   69336551          0          0          0          0          0          0          0   PCI-MSI-edge      virtio3-requests
	 26:          0          0          0          0          0          0          0          0   PCI-MSI-edge      virtio4-config
	 27:  108049865          0          0          0          0          0          0          0   PCI-MSI-edge      virtio4-requests
	 28:          0          0          0          0          0          0          0          0   PCI-MSI-edge      virtio0-config
	 29:       3553          0          0          0 1651785749          0          0    1548640   PCI-MSI-edge      virtio0-input.0
	 30:          2          0          0          0          0   14346435          0          0   PCI-MSI-edge      virtio0-output.0
	 31:          0          0          0          0          0          0          0          0   PCI-MSI-edge      virtio1-config
	 32:        183          0          0          0          0          0          0  339024186   PCI-MSI-edge      virtio1-input.0
	 33:         69          0          0          0          0          0          0          0   PCI-MSI-edge      virtio1-output.0
	 34:          0          0          0          0          0          0          0          0   PCI-MSI-edge      virtio2-config
	 35:          2          0          0          0          0          0          0          0   PCI-MSI-edge      virtio2-virtqueues
	NMI:    9629760    9280872    9059781    8820769   13611895    8691234    8649973    8628109   Non-maskable interrupts
	LOC: 3689281585 2966961856 1990997561 1398436662 1948336108  964408213  875622739  795417546   Local timer interrupts
	SPU:          0          0          0          0          0          0          0          0   Spurious interrupts
	PMI:    9629760    9280872    9059781    8820769   13611895    8691234    8649973    8628109   Performance monitoring interrupts
	IWI:          0          0          0          0          0          0          0          0   IRQ work interrupts
	RES:  756720364 3990084810 3025818934 2580726910 1767695093 2328232700 2193516960 2060476615   Rescheduling interrupts
	CAL:     686938     691282     693895     697113     697532     703129     707310     712521   Function call interrupts
	TLB:  231784488  230907861  220249459  197662552  178879411  156604448  139075073  126648066   TLB shootdowns
	TRM:          0          0          0          0          0          0          0          0   Thermal event interrupts
	THR:          0          0          0          0          0          0          0          0   Threshold APIC interrupts
	MCE:          0          0          0          0          0          0          0          0   Machine check exceptions
	MCP:     146922     146922     146922     146922     146922     146922     146922     146922   Machine check polls
	ERR:          0
	MIS:          0

上面可以看到CPU4的中断号29较多，属于virtio0-input.0，网络输入。

根据中断号，查询了其中断亲缘性:

	# cat /proc/irq/29/smp_affinity
	10
	# cat /proc/irq/29/smp_affinity_list 
	4

可以发现中断29的确是有CPU4处理的。

	# echo 7 > /proc/irq/29/smp_affinity_list 
	# cat /proc/irq/29/smp_affinity_list 
	7
	# cat /proc/irq/29/smp_affinity
	80
此时再次查看中断数，可以明显发现29的中断由CPU7响应了，CPU4不再响应中断29。

	# grep virtio0-input.0 /proc/interrupts 
	 29:       3553          0          0          0 1657258151          0          0    4983095   PCI-MSI-edge      virtio0-input.0
	# grep virtio0-input.0 /proc/interrupts 
	 29:       3553          0          0          0 1657258151          0          0    4991933   PCI-MSI-edge      virtio0-input.0

并且CPU7的si显著提升，CPU4的si恢复，基本可以断定si高的原因就是virtio0-input.0中断引起的。

	Tasks: 229 total,   6 running, 223 sleeping,   0 stopped,   0 zombie
	Cpu0  : 37.7%us, 18.2%sy,  0.0%ni, 42.8%id,  0.7%wa,  0.0%hi,  0.0%si,  0.7%st
	Cpu1  : 29.8%us, 14.0%sy,  0.0%ni, 55.1%id,  0.0%wa,  0.0%hi,  0.0%si,  1.0%st
	Cpu2  : 28.0%us, 13.2%sy,  0.0%ni, 57.1%id,  0.0%wa,  0.0%hi,  0.3%si,  1.4%st
	Cpu3  : 32.5%us, 14.6%sy,  0.0%ni, 52.2%id,  0.0%wa,  0.0%hi,  0.0%si,  0.7%st
	Cpu4  : 14.2%us,  9.9%sy,  0.0%ni, 74.8%id,  0.0%wa,  0.0%hi,  0.0%si,  1.0%st
	Cpu5  : 24.4%us, 12.4%sy,  0.0%ni, 61.9%id,  0.0%wa,  0.0%hi,  0.0%si,  1.3%st
	Cpu6  : 21.4%us, 11.9%sy,  0.0%ni, 65.6%id,  0.0%wa,  0.0%hi,  0.0%si,  1.0%st
	Cpu7  : 13.8%us,  7.6%sy,  0.0%ni, 32.2%id,  0.0%wa,  0.0%hi, 45.0%si,  1.4%st
	Mem:   7828428k total,  7615392k used,   213036k free,    10524k buffers
	Swap:  4194300k total,   173236k used,  4021064k free,  6426756k cached

因此，接下来的问题是如何均衡这个软中断响应。


	
方案1、配置多核响应中断29

	# echo 2,7 > /proc/irq/29/smp_affinity_list 
发现中断都转移到CPU2上去了。未生效
方案2、使用irqbalance
	
	# uname -r
	2.6.32-504.12.2.02.qiyi.el6.x86_64
	# yum install irqbalance -y
	# rpm -qa | grep irq
	irqbalance-1.0.4-3.el6.x86_64
	# service irqbalance start
	Starting irqbalance:                                       [  OK  ]
	# service irqbalance status
	irqbalance (pid 7820) is running...
	# service irqbalance status
	irqbalance is stopped
发现irqbalance进程自动stop了。未生效。

参考:
1、[Introduction to Linux Interrupts and CPU SMP Affinity](http://www.thegeekstuff.com/2014/01/linux-interrupts/?utm_source=feedburner)
2、[记录一个软中断问题](https://huoding.com/2013/10/30/296)
3、[SMP affinity and proper interrupt handling in Linux](http://www.alexonlinux.com/smp-affinity-and-proper-interrupt-handling-in-linux)
4、[Linux: scaling softirq among many CPU cores](http://natsys-lab.blogspot.com/2012/09/linux-scaling-softirq-among-many-cpu.html)
5、[Understanding Linux CPU stats](http://blog.scoutapp.com/articles/2015/02/24/understanding-linuxs-cpu-stats)
