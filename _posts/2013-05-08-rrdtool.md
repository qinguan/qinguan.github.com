---
layout: post
title: RRDTool
---

RRDTool
========================
8 May 2013 - Beijing

由于关注服务的状态，因此需要有个监控和定期汇总状态的工具，当然，Zabbix可以通过模板很容易的完成这事。偶然间在网上发现了RRDTool，据说也是一神器，但本着爱折腾的心，好歹也要试一试。

# 介绍
RRDtool 是 Round Robin Database tool的缩写，环状数据库工具，由瑞士联邦理工学院(Swiss Federal Institute of Technology)的一名系统管理员Tobias Oetiker开发的(想想Perl的起源，需求真是第一生产力，系统管理员真不是盖的)。

"Round Robin" 其实是一种存储数据的方式，使用固定大小的空间来存储数据，并维护一个指向最新数据位置的指针。
我们可以把用于存储数据的数据库的空间看成一个圆，上面有很多刻度。这些刻度所在的位置就代表用于存储数据的地方。所谓指针，可以认为是从圆心指向这些刻度的一条直线。指针会随着数据的读写操作自动移动。要注意的是，这个圆没有起点和终点，所以指针可以一直移动，而不用担心到达终点后就无法前进的问题。在一段时间后，当所有的空间都存满了数据，就又从头开始存放。这样，整个存储空间的大小就是一个固定的数值。

# 安装
	$ sudo apt-get install rrdtool (yum install rrdtool)
	
	$ rrdtool
	RRDtool 1.4.3  Copyright 1997-2009 by Tobias Oetiker <tobi@oetiker.ch>
				   Compiled Mar 26 2011 03:11:21

	Usage: rrdtool [options] command command_options
	Valid commands: create, update, updatev, graph, graphv,  dump, restore,
			last, lastupdate, first, info, fetch, tune,
			resize, xport, flushcached

	RRDtool is distributed under the Terms of the GNU General
	Public License Version 2. (www.gnu.org/copyleft/gpl.html)

	For more information read the RRD manpages
	$

	
# 创建数据库 [rrdcreate](http://oss.oetiker.ch/rrdtool/doc/rrdcreate.en.html)

	rrdtool create filename 
		[--start|-b start time] 
		[--step|-s step] 
		[--no-overwrite] 
		[DS:ds-name:DST:dst arguments] 
		[RRA:CF:cf arguments]
	其中filename、DS及RRA是必须的，其它参数非必须。
	
	filename:
		RRD文件，即数据最终存储的文件，.rrd后缀，如test.rrd。
	--start:
		第一个记录的起始时间，即数据库的最早时间，RRDTool不接受任何采样时间小于或等于指定时间的数据，default: NOW - 10s。
	--step:
		数据写入RRD的间隔，也即RRDTool期望每隔多长时间收到一个值，default: 300s。
	DS:
		Data Source，存放数据的变量名。必须是[a-zA-Z0-9_],长度为1~19个字符。
	DST：
		Data Source Type。有 COUNTER、GUAGE、DERIVE、ABSOLUTE、COMPUTE 5种。
		COUNTER: 必须是递增的，除非是计数器溢出（overflows）。
		DERIVE：和COUNTER类似。但可以是递增，也可以递减，或者一会增加一会儿减少。
		ABSOLUTE：比较特殊，它每次都假定前一个interval的值是0，再计算平均值。
		GAUGE: GAGUE 和上面三种不同，它没有"平均"的概念，RRDtool收到值之后直接存入RRA中。
		COMPUTE: COMPUTE 比较特殊，它并不接受输入，它的定义是一个表达式，能够引用其他DS并自动计算出某个值。
	
	RRA:
		指定数据如何存放。
		CF:
			Consolidation Function。有四种方式：AVERAGE, MIN, MAX, LAST，分别表示对多个PDP 进行取平均、取最大值、取最小值、取当前值四种类型
		cf arguments：
			即xff:steps:rows
		例子: 
		RRA:AVERAGE:0.5:12:24
		RRA:AVERAGE:0.5:288:31

		第一个RRA，12(steps)个PDPs(DS variables)求均值得到一个CDP，24(rows) CDPs形成归档。	每300s产生一个PDP，12个PDP就是1小时，24个CDPs代表一天，即RRA:AVERAGE:0.5:12:24是一天的归档。当形成第25个CDP后，会覆盖第一个CDP。
		第二个RRA保存31个CDPs，每个CDP是一天的均值(288=12* 24, 288 * 300s = 24小时),因此这个RRA是一个月的数据归档。
		xff: 比例值，0~1之间。eg: xff=0.5，则当PDP个数小于steps的一半时，则CDP值为unknown。

	补充介绍概念:
	PDP:
		Primary Data Point。正常情况下每个interval RRDtool都会收到一个值，RRDtool在接受值后会计算出另外一个值(例如平均值)，这个值就是PDP，一般代表"xxx/s"的含义。该值当且仅当DST为GAUGE 时，等于RRDtool收到的那个值。   
	CDP:
		Consolidation Data Point。RRDtool使用多个PDP合并为(计算出)一个CDP。即执行CF操作后的结果。这个值就是存入RRA的数据，绘图时使用的也是这些数据。
	  

	$ rrdtool create test.rrd \
	--start $(date -d "1 day ago" +%s) \
	--step 300 \
	DS:value1:GAUGE:600:0:U	\
	DS:value2:GAUGE:600:0:U	\
	DS:value3:GAUGE:600:0:U	\
	DS:value4:GAUGE:600:0:U	\
	RRA:AVERAGE:0.5:1:2016	  \ 
	RRA:AVERAGE:0.5:12:2160   \ 
	RRA:AVERAGE:0.5:288:365     

	U表示上限未知
	三条RRA:
	#每5分钟->一周12*24*7 = 2016
	#每小时->一个月24*30*3 = 2160
	#每天->一年12*24*365
	
# 查询RRD文件结构信息 [rrdinfo](http://oss.oetiker.ch/rrdtool/doc/rrdinfo.en.html)
	$ rrdtool info test.rrd
	filename = "test.rrd"
	rrd_version = "0003"
	step = 300
	last_update = 1366472359
	header_size = 2348
	ds[value1].index = 0
	ds[value1].type = "GAUGE"
	ds[value1].minimal_heartbeat = 600
	ds[value1].min = 0.0000000000e+00
	ds[value1].max = NaN
	ds[value1].last_ds = "U"
	ds[value1].value = 0.0000000000e+00
	ds[value1].unknown_sec = 259
	ds[value2].index = 1
	ds[value2].type = "GAUGE"
	ds[value2].minimal_heartbeat = 600
	ds[value2].min = 0.0000000000e+00
	ds[value2].max = NaN
	ds[value2].last_ds = "U"
	ds[value2].value = 0.0000000000e+00
	ds[value2].unknown_sec = 259
	ds[value3].index = 2
	ds[value3].type = "GAUGE"
	ds[value3].minimal_heartbeat = 600
	ds[value3].min = 0.0000000000e+00
	ds[value3].max = NaN
	ds[value3].last_ds = "U"
	ds[value3].value = 0.0000000000e+00
	ds[value3].unknown_sec = 259
	ds[value4].index = 3
	ds[value4].type = "GAUGE"
	ds[value4].minimal_heartbeat = 600
	ds[value4].min = 0.0000000000e+00
	ds[value4].max = NaN
	ds[value4].last_ds = "U"
	ds[value4].value = 0.0000000000e+00
	ds[value4].unknown_sec = 259
	rra[0].cf = "AVERAGE"
	rra[0].rows = 2016
	rra[0].cur_row = 132
	rra[0].pdp_per_row = 1
	rra[0].xff = 5.0000000000e-01
	rra[0].cdp_prep[0].value = NaN
	rra[0].cdp_prep[0].unknown_datapoints = 0
	rra[0].cdp_prep[1].value = NaN
	rra[0].cdp_prep[1].unknown_datapoints = 0
	rra[0].cdp_prep[2].value = NaN
	rra[0].cdp_prep[2].unknown_datapoints = 0
	rra[0].cdp_prep[3].value = NaN
	rra[0].cdp_prep[3].unknown_datapoints = 0
	rra[1].cf = "AVERAGE"
	rra[1].rows = 2160
	rra[1].cur_row = 1426
	rra[1].pdp_per_row = 12
	rra[1].xff = 5.0000000000e-01
	rra[1].cdp_prep[0].value = NaN
	rra[1].cdp_prep[0].unknown_datapoints = 7
	rra[1].cdp_prep[1].value = NaN
	rra[1].cdp_prep[1].unknown_datapoints = 7
	rra[1].cdp_prep[2].value = NaN
	rra[1].cdp_prep[2].unknown_datapoints = 7
	rra[1].cdp_prep[3].value = NaN
	rra[1].cdp_prep[3].unknown_datapoints = 7
	rra[2].cf = "AVERAGE"
	rra[2].rows = 365
	rra[2].cur_row = 354
	rra[2].pdp_per_row = 288
	rra[2].xff = 5.0000000000e-01
	rra[2].cdp_prep[0].value = NaN
	rra[2].cdp_prep[0].unknown_datapoints = 187
	rra[2].cdp_prep[1].value = NaN
	rra[2].cdp_prep[1].unknown_datapoints = 187
	rra[2].cdp_prep[2].value = NaN
	rra[2].cdp_prep[2].unknown_datapoints = 187
	rra[2].cdp_prep[3].value = NaN
	rra[2].cdp_prep[3].unknown_datapoints = 187
	$ 	
	
# 查看最新/旧的一次更新 [rrdfirst](http://oss.oetiker.ch/rrdtool/doc/rrdfirst.en.html),[rrdlast](http://oss.oetiker.ch/rrdtool/doc/rrdlast.en.html)
返回的是UNIX时间戳，转化为当前时间

	$ rrdtool last test.rrd | xargs -i date -d '1970-01-01 {} sec utc'
	2013年 04月 20日 星期六 23:39:19 CST
	$ rrdtool first test.rrd | xargs -i date -d '1970-01-01 {} sec utc'
	2013年 04月 13日 星期六 23:40:00 CST
	$ 	
	
# 查看最新的记录 [rrdlastupdate](http://oss.oetiker.ch/rrdtool/doc/rrdlastupdate.en.html)
	$ rrdtool lastupdate test.rrd
	 value1 value2 value3 value4

	1366472359: U U U U
	
# update操作,即插入操作
	rrdtool {update | updatev} filename 
	[--template|-t ds-name[:ds-name]...] 
	[--daemon address] [--] 
	N|timestamp:value[:value...] at-timestamp@value[:value...] [timestamp:value[:value...] ...]	
	
	updatem命令分两部分:
	A:时间戳:
		1,数字形式: 1366472359(可用`date +%s`代替); 
		2,快捷形式:N,表示当前时间; 
		3,at风格，如now、yesterday、now-1hour、now+5min,则与value之间需要用@分割而不是用:
	B:数值部分
		一个RRD文件可以有多个DS，所以一次update可以给出多个value。多个value之间用":"分隔。
		
	$ rrdtool update test.rrd `date +%s`:1:2:3:4
	$ rrdtool lastupdate test.rrd
	 value1 value2 value3 value4

	1366562329: 1 2 3 4
	
	对于特定的DS，若没有数据，可以用U代替
	$ rrdtool update test.rrd `date +%s`:1:2:U:4
	$ rrdtool lastupdate test.rrd
	 value1 value2 value3 value4

	1366562398: 1 2 U 4
	
	如果要update数据库，则update操作给出的时间戳必须晚于最后一次update的时间。(rrd不允许对已插入的值进行修改，回不去的节奏)
	$ rrdtool update test.rrd 1366562398:1:2:U:4
	ERROR: test.rrd: illegal attempt to update using time 1366562398 when last update time is 1366562398 (minimum one second step)
	$
	
	看数据是否插入成功:
	$ rrdtool updatev test.rrd N:6:7:5:4
	return_value = 0
	[1366563000]RRA[AVERAGE][1]DS[value1] = 6.0000000000e+00
	[1366563000]RRA[AVERAGE][1]DS[value2] = 7.0000000000e+00
	[1366563000]RRA[AVERAGE][1]DS[value3] = 5.0000000000e+00
	[1366563000]RRA[AVERAGE][1]DS[value4] = 4.0000000000e+00
	$ 
	return value可以理解为 shell编程中的exit status。updatev用0表示成功，-1表示失败。 
	
	两个问题待解决:
	A） 如果test.rrd在step时间(默认5分钟)内收到不止1个更新，结果会怎样？
	B） 如果过了test.rrd在5分钟内没有收到脚本返回的值，是否立即就用 UNKNOWN 作为 PDP 的值？ 

	$ rrdtool updatev test.rrd N:6:7:10:9
	return_value = 0
	[1366563600]RRA[AVERAGE][1]DS[value1] = 6.0000000000e+00
	[1366563600]RRA[AVERAGE][1]DS[value2] = 7.0000000000e+00
	[1366563600]RRA[AVERAGE][1]DS[value3] = 8.7762100667e+00  #为什么这个值没有显示10,而lastupdate读取的时候是正确的?
	[1366563600]RRA[AVERAGE][1]DS[value4] = 9.0000000000e+00
	$ rrdtool lastupdate test.rrd
	 value1 value2 value3 value4

	1366563606: 6 7 10 9
	$ rrdtool updatev test.rrd N:6:7:11:9
	return_value = 0
	$ rrdtool lastupdate test.rrd
	 value1 value2 value3 value4

	1366563624: 6 7 11 9
	$ 
	
# 作图	
	rrdtool graph|graphv filename 
	[option ...] 
	[data definition ...] 
	[data calculation ...] 
	[variable definition ...] 
	[graph element ...] 
	[print element ...]
	
===================================
	
# 实例:

	#!/bin/bash

	 # create a rrd file

	 rrdfile=loadavg.rrd
	 STEP=2
	 HEARTBEAT=4
	 now=`date +%s`

	  if [ ! -f $rrdfile ]
	 then
		 rrdtool create $rrdfile --start $now --step $STEP \
			 DS:loadavg5:GAUGE:$HEARTBEAT:U:U              \
			 DS:loadavg10:GAUGE:$HEARTBEAT:U:U             \
			 DS:loadavg15:GAUGE:$HEARTBEAT:U:U             \
			 RRA:MAX:0.5:3:3600
	  else
		 echo "$rrdfile already exists, remove it"
	 fi

	 TEMPLATE_STR="loadavg5:loadavg10:loadavg15"

	  while :
	  do
		 loadavg5=`cat /proc/loadavg  | awk '{print $1}'`
		 loadavg10=`cat /proc/loadavg | awk '{print $2}'`
		 loadavg15=`cat /proc/loadavg | awk '{print $3}'`
		 rrdtool update $rrdfile                           \
			 --template $TEMPLATE_STR                      \
			 N:$loadavg5:$loadavg10:$loadavg15

		 sleep $STEP
	 done	
	
	
===================================

	#!/bin/bash

	rrdfile=loadavg.rrd
	PIC=loadavg.png

	rrdtool graph $PIC                 \
     --title "CPU负载"                 \
     --vertical-label "负载"           \
     --color "BACK#CCCCCC"             \
     --color "CANVAS#CCFFFF"           \
     --color "SHADEA#DDDDDD"           \
     --color "SHADEB#9999CC"           \
     --color "FRAME#006600"            \
     --color "FONT#006699"             \
     --color "ARROW#FF55FF"            \
     --color "AXIS#000000"             \
     --height 400                      \
     --width  800                      \
     --slope-mode                      \
     --alt-autoscale                   \
     --lower-limit 0                   \
     -Y -X 0                           \
     --start -4H --end now             \
     --x-grid MINUTE:12:HOUR:1:HOUR:1:0:'%H'     \
     DEF:max_loadavg5=$rrdfile:loadavg5:MAX      \
     DEF:max_loadavg10=$rrdfile:loadavg10:MAX    \
     DEF:max_loadavg15=$rrdfile:loadavg15:MAX    \
     COMMENT:"\n"                                \
     COMMENT:"\n"                                \
     COMMENT:"\t\t\t当前值\t\t最大值"            \
     COMMENT:"\n"                                \
     LINE1:max_loadavg5#0000FF:loadavg5          \
     GPRINT:max_loadavg5:LAST:"\:%8.0lf"         \
     GPRINT:max_loadavg5:MAX:"\:%8.0lf"          \
     COMMENT:"\n"                                \
     LINE1:max_loadavg10#00FF00:loadavg10        \
     GPRINT:max_loadavg10:LAST:"\:%8.0lf"     	 \
     GPRINT:max_loadavg10:MAX:"\:%8.0lf"     	 \
     COMMENT:"\n"                                \
     LINE1:max_loadavg15#FF00FF:loadavg15        \
     GPRINT:max_loadavg15:LAST:"\:%8.0lf"        \
     GPRINT:max_loadavg15:MAX:"\:%8.0lf"         \
     COMMENT:"\n"                                \
     HRULE:1#FF0000:"报警值"                     \
     COMMENT:"\n"                                \
     COMMENT:"Last update\: $(date '+%Y-%m-%d %H\:%M\:%S' -r $rrdfile)\r" \
     COMMENT:"\n"                               \
     COMMENT:"created by qinguan\r"	
	